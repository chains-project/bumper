import static java.util.concurrent.TimeUnit.MINUTES;
import static java.util.concurrent.TimeUnit.SECONDS;

import com.jcabi.ssh.Session;
import java.io.File;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.concurrent.TimeExceededException;
import org.apache.commons.io.input.TeeInputStream;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import us.monoid.webdav.Lenient;
import us.monoid.webdav.Raw;
import us.monoid.webdav.WebdavClient;

@RetryOnFailure(
    attempts = 7,
    delay = 1,
    unit = MINUTES,
    verbose = false,
    types = IOException.class
)
protected Session session() throws IOException {
    final File file = File.createTempFile("jcabi-ssh", ".key");
    try {
        final WebdavClient webdav = new WebdavClient(new Lenient());
        new Unchecked<>(
            new LengthOf(
                new TeeInput(
                    this.key.replaceAll("\r", "")
                        .replaceAll("\n\\s+|\n{2,}", "\n")
                        .trim(),
                    file
                )
            )
        ).value();
        webdav.put(file.getAbsolutePath(), new Raw(this.key));
        Logger logger = LoggerFactory.getLogger(Ssh.class);
        if (this.passphrase == null) {
            webdav.authenticate(this.getLogin(), file.getAbsolutePath());
        } else {
            webdav.authenticate(
                this.getLogin(),
                this.key.getBytes(StandardCharsets.UTF_8),
                null,
                this.passphrase.getBytes(StandardCharsets.UTF_8)
            );
        }
        logger.debug(
            this,
            "Opening SSH session to {}@{}:{} ({})...",
            this.getLogin(), this.getAddr(), this.getPort(),
            Files.size(file.toPath())
        );
        return this.session(webdav);
    } catch (final IOException | TimeExceededException ex) {
        throw new IOException(ex);
    } finally {
        Files.deleteIfExists(file.toPath());
    }
}