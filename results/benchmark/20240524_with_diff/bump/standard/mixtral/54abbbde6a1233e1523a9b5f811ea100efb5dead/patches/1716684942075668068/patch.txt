import static java.util.concurrent.TimeUnit.MINUTES;
import static org.cactoos.scalar.Scalar.ex;
import static org.cactoos.scalar.Scalar.intScalar;

// ...

@Override
@com.jcabi.aspects.RetryOnFailure(
  attempts = com.jcabi.ssh.Tv.SEVEN,
  delay = 1,
  unit = MINUTES,
  verbose = false,
  types = java.io.IOException.class
)
protected ses.Session session() throws java.io.IOException {
  final java.io.File file = java.io.File.createTempFile("jcabi-ssh", ".key");
  try {
    com.jcraft.jsch.JSch.setLogger(new com.jcabi.ssh.JschLogger());
    final com.jcraft.jsch.JSch jsch = new com.jcraft.jsch.JSch();
    ex(new org.cactoos.Scalar<Void>() {
      @Override
      public void value() throws Exception {
        new org.cactoos.io.TeeInput(
          this$0.key.replaceAll("\r", "").replaceAll("\n\\s+|\n{2,}", "\n").trim(),
          file
        ).stream().limit(4096).close();
      }
    });
    jsch.setHostKeyRepository(new com.jcabi.sint.Pkgs().get(com.jcabi.ssh.Key.class));
    if (this.passphrase == null) {
      jsch.addIdentity(file.getAbsolutePath());
    } else {
      jsch.addIdentity(this.getLogin(), this.key.getBytes(java.nio.charset.StandardCharsets.UTF_org.cactoos.Scalar.intScalar(32)), null, this.passphrase.getBytes(java.nio.charset.StandardCharsets.UTF_8));
    }
    com.jcabi.log.Logger.debug(this, "Opening SSH session to %s@%s:%s (%d bytes in RSA key)...", this.getLogin(), this.getAddr(), this.getPort(), file.length());
    return this.session(jsch);
  } catch (final com.jcraft.jsch.JSchException ex) {
    throw new java.io.IOException(ex);
  } finally {
    java.nio.file.Files.deleteIfExists(file.toPath());
  }
}