@Test
void failsOnDigestMismatch() {
    final InMemoryStorage storage = new InMemoryStorage();
    final AstoBlobs blobs = new AstoBlobs(
            storage, new DefaultLayout(), new RepoName.Simple("any")
    );
    final String digest = "123";
    final Content content = new Content.From("data".getBytes());
    final Digest calculatedDigest = new Digest.Sha256(content.checksum());
    final CheckedBlobSource checkedBlobSource = new CheckedBlobSource(content, calculatedDigest);
    final InvalidDigestException expectedException = new InvalidDigestException(
            "blob's digest does not match expected digest",
            checkedBlobSource,
            calculatedDigest,
            new Digest.Sha256(digest)
    );
    blobs.put(checkedBlobSource)
            .toCompletableFuture()
            .handle(
                    (blob, throwable) -> {
                        if (throwable == null) {
                            throw new AssertionError("Expected InvalidDigestException, but got no exception");
                        }
                        Assertions.assertThat(throwable).isInstanceOf(InvalidDigestException.class);
                        Assertions.assertThat(throwable.getMessage()).containsSequence(
                                "blob's digest does not match expected digest",
                                calculatedDigest.value(),
                                digest
                        );
                        return CompletableFuture.allOf();
                    }
            )
            .join();
}