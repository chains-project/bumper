import org.hamcrest.Matchers;
import org.junit.jupiter.api.Test;

import java.nio.charset.StandardCharsets;
import java.util.concurrent.CompletableFuture;

import static com.artipie.docker.asto.AstoBlobsITCase.content;
import static com.artipie.docker.asto.AstoBlobsITCase.repoName;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.instanceOf;

@Test
void failsOnDigestMismatch() {
    final com.artipie.asto.memory.InMemoryStorage storage = new com.artipie.asto.memory.InMemoryStorage();
    final com.artipie.docker.asto.AstoBlobs blobs = new com.artipie.docker.asto.AstoBlobs(
        storage, new com.artipie.docker.asto.DefaultLayout(), repoName("any")
    );
    final String digest = "123";
    blobs.put(
        new com.artipie.docker.asto.CheckedBlobSource(
            content("data".getBytes(StandardCharsets.UTF_8)),
            new com.artipie.docker.Digest.Sha256(digest)
        )
    ).toCompletableFuture().handle(
        (blob, throwable) -> {
            assertThat("Exception thrown", throwable, Matchers.notNullValue());
            assertThat(
                "Exception is InvalidDigestException",
                throwable,
                instanceOf(com.artipie.docker.error.InvalidDigestException.class)
            );
            assertThat(
                "Exception message contains calculated digest",
                throwable.getMessage(),
                Matchers.stringContains(
                    "3a6eb0790f39ac87c94f3856b2dd2c5d110e6811602261a9a923d3bb23adc8b7"
                )
            );
            assertThat(
                "Exception message contains expected digest",
                throwable.getMessage(),
                Matchers.stringContains(digest)
            );
            return CompletableFuture.allOf();
        }
    ).join();
}

static byte[] content(final String string) {
    return content(string.getBytes(StandardCharsets.UTF_8));
}

static byte[] content(final byte[] bytes) {
    return bytes;
}

static com.artipie.docker.RepoName.RepoName repoName(final String name) {
    return new com.artipie.docker.RepoName.Simple(name);
}